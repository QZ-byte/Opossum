All project .py files dump
Generated: 2025-10-24T13:28:07.095217
Project root: c:\Users\Q#\Desktop\Raccon Build 12.22


--- FILE: main.py ---
from ui.main_ui import RacconApp

if __name__ == "__main__":
    app = RacconApp(db_path="raccon.db")
    app.run()


--- FILE: services\db.py ---
import sqlite3
from typing import Tuple, Iterable, Optional


class Database:
    def __init__(self, path: str):
        self.path = path
        self.conn = sqlite3.connect(self.path, check_same_thread=False)
        self.conn.row_factory = sqlite3.Row
        self._init_schema()

    def _init_schema(self):
        cur = self.conn.cursor()
        cur.execute(
            """
            CREATE TABLE IF NOT EXISTS notes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                content TEXT NOT NULL DEFAULT '',
                tags TEXT NOT NULL DEFAULT '',
                created_at TEXT NOT NULL DEFAULT (datetime('now'))
            )
            """
        )
        self.conn.commit()
        cur.close()

    def execute(self, sql: str, params: Tuple = ()) -> None:
        cur = self.conn.cursor()
        cur.execute(sql, params)
        self.conn.commit()
        cur.close()

    def fetchall(self, sql: str, params: Tuple = ()) -> Iterable[sqlite3.Row]:
        cur = self.conn.cursor()
        cur.execute(sql, params)
        rows = cur.fetchall()
        cur.close()
        return rows

    def fetchone(self, sql: str, params: Tuple = ()) -> Optional[sqlite3.Row]:
        cur = self.conn.cursor()
        cur.execute(sql, params)
        row = cur.fetchone()
        cur.close()
        return row

    def close(self):
        self.conn.close()


--- FILE: services\notes_service.py ---
# services/notes_service.py
import json
import html
import os
from typing import List, Tuple, Optional
from datetime import datetime
from services.db import Database


class NotesService:
    def __init__(self, db: Database):
        self.db = db
        self._ensure_format_meta()

    def _ensure_format_meta(self):
        try:
            self.db.execute("ALTER TABLE notes ADD COLUMN format_meta TEXT NOT NULL DEFAULT '{}'")
        except Exception:
            pass

    def create_note(self, title: str, content: str = "", tags: str = "", format_meta: str = "{}") -> None:
        fm = self._normalize_format_meta(format_meta)
        self.db.execute(
            "INSERT INTO notes(title, content, tags, format_meta, created_at) VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)",
            (title, content, tags, fm)
        )

    def get_all_notes(self) -> List[Tuple]:
        rows = self.db.fetchall("SELECT id, title, tags, created_at FROM notes ORDER BY id DESC")
        return [tuple(r) for r in rows] if rows else []

    def get_note_by_id(self, note_id: int) -> Optional[Tuple]:
        # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç_meta –≤–º–µ—Å—Ç–µ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
        try:
            row = self.db.fetchone(
                "SELECT id, title, content, tags, created_at, COALESCE(format_meta, '{}') as format_meta FROM notes WHERE id = ?",
                (note_id,)
            )
            if row:
                return tuple(row)
            return None
        except Exception:
            # –ï—Å–ª–∏ —Å—Ö–µ–º–∞ —Å—Ç–∞—Ä–∞—è –∏ column missing ‚Äî –≤–µ—Ä–Ω—É—Ç—å 6-—ç–ª–µ–º–µ–Ω—Ç–Ω—ã–π –∫–æ—Ä—Ç–µ–∂ —Å –¥–µ—Ñ–æ–ª—Ç–æ–º
            row = self.db.fetchone(
                "SELECT id, title, content, tags, created_at FROM notes WHERE id = ?",
                (note_id,)
            )
            if row:
                vals = tuple(row)
                return (*vals, "{}")
            return None

    def search_notes(self, query: str) -> List[Tuple]:
        q = f"%{query}%"
        rows = self.db.fetchall(
            "SELECT id, title, tags, created_at FROM notes WHERE title LIKE ? OR tags LIKE ? ORDER BY id DESC",
            (q, q)
        )
        return [tuple(r) for r in rows] if rows else []

    def update_note(self, note_id: int, title: str, content: str, tags: str, format_meta: str = "{}") -> None:
        fm = self._normalize_format_meta(format_meta)
        self.db.execute(
            "UPDATE notes SET title = ?, content = ?, tags = ?, format_meta = ? WHERE id = ?",
            (title, content, tags, fm, note_id)
        )

    def delete_note(self, note_id: int) -> None:
        self.db.execute("DELETE FROM notes WHERE id = ?", (note_id,))

    def export_note_md(self, note_id: int, path: str) -> None:
        note = self.get_note_by_id(note_id)
        if not note:
            raise ValueError("–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        _id, title, content, tags, created_at, _ = note
        title_text = title or "(–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)"
        lines = [
            f"# {title_text}",
            "",
            f"- ID: {_id}",
            f"- –°–æ–∑–¥–∞–Ω–æ: {created_at}",
            f"- –¢–µ–≥–∏: {tags or ''}",
            "",
            content or ""
        ]
        os.makedirs(os.path.dirname(path) or ".", exist_ok=True)
        with open(path, "w", encoding="utf-8") as f:
            f.write("\n".join(lines))

    def export_note_html(self, note_id: int, path: str) -> None:
        note = self.get_note_by_id(note_id)
        if not note:
            raise ValueError("–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        _id, title, content, tags, created_at, _ = note
        title_safe = html.escape(title or "(–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)")
        content_safe = html.escape(content or "").replace("\n", "<br>\n")
        tags_safe = html.escape(tags or "")
        created_safe = html.escape(created_at or "")
        html_doc = f"""<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>{title_safe}</title>
<style>
body {{ font-family: Segoe UI, Arial, sans-serif; max-width: 900px; margin: 2rem auto; color: #222; }}
.meta {{ color: #555; font-size: 0.9rem; margin-bottom: 0.8rem; }}
.content {{ margin-top: 1rem; line-height: 1.6; }}
hr {{ margin: 1rem 0; }}
</style>
</head>
<body>
<h1>{title_safe}</h1>
<div class="meta">
  <div><strong>ID:</strong> {_id}</div>
  <div><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> {created_safe}</div>
  <div><strong>–¢–µ–≥–∏:</strong> {tags_safe}</div>
</div>
<hr>
<div class="content">
  {content_safe}
</div>
</body>
</html>
"""
        os.makedirs(os.path.dirname(path) or ".", exist_ok=True)
        with open(path, "w", encoding="utf-8") as f:
            f.write(html_doc)

    def _normalize_format_meta(self, fm) -> str:
        if fm is None:
            return "{}"
        if isinstance(fm, dict):
            try:
                return json.dumps(fm, ensure_ascii=False)
            except Exception:
                return "{}"
        if isinstance(fm, str):
            try:
                json.loads(fm)
                return fm
            except Exception:
                return "{}"
        return "{}"


--- FILE: ui\debug_ui.py ---
# ui/debug_ui.py
import tkinter as tk
from tkinter import ttk
import sys, logging, queue, time, os, datetime, io

class _StreamProxy:
    def __init__(self, q, name):
        self.q = q
        self.name = name
    def write(self, data):
        if data:
            self.q.put((self.name, str(data)))
    def flush(self):
        pass

class _QueueLoggingHandler(logging.Handler):
    def __init__(self, q):
        super().__init__()
        self.q = q
    def emit(self, record):
        try:
            msg = self.format(record)
            self.q.put(("log", msg))
        except Exception:
            pass

class DebugUI:
    def __init__(self, master, autostart=False):
        self.win = tk.Toplevel(master)
        self.win.title("Debugger")
        self.win.geometry("880x520")

        self.output = tk.Text(self.win, wrap="word", state="disabled", bg="black", fg="lime")
        self.output.pack(fill="both", expand=True, padx=6, pady=6)

        ctrl = ttk.Frame(self.win); ctrl.pack(fill="x", padx=6, pady=(0,6))
        self.start_btn = ttk.Button(ctrl, text="‚ñ∂ –°—Ç–∞—Ä—Ç", command=self.start); self.start_btn.pack(side="left", padx=4)
        self.stop_btn = ttk.Button(ctrl, text="‚èπ –°—Ç–æ–ø", command=self.stop); self.stop_btn.pack(side="left", padx=4)
        self.save_btn  = ttk.Button(ctrl, text="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", command=self.save); self.save_btn.pack(side="left", padx=4)
        self.mode_var = tk.StringVar(value="all")
        ttk.Radiobutton(ctrl, text="All", variable=self.mode_var, value="all").pack(side="left", padx=6)
        ttk.Radiobutton(ctrl, text="Errors only", variable=self.mode_var, value="errors").pack(side="left")

        # –æ—á–µ—Ä–µ–¥—å –∏ –±—É—Ñ–µ—Ä
        self.q = queue.Queue()
        self.buffer = io.StringIO()

        # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—ã
        self._orig_stdout = sys.stdout
        self._orig_stderr = sys.stderr
        self._orig_handlers = logging.getLogger().handlers[:]

        # logging handler
        self._log_handler = _QueueLoggingHandler(self.q)
        self._log_handler.setFormatter(logging.Formatter("%(asctime)s [%(levelname)s] %(message)s", "%H:%M:%S"))

        # —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        self.active = False

        # –∑–∞–ø—É—Å–∫ –ø–æ–ª–ª–∏–Ω–≥–∞
        self._poll()

        if autostart:
            self.start()

    def _append(self, line: str):
        self.output.configure(state="normal")
        self.output.insert("end", line + "\n")
        self.output.see("end")
        self.output.configure(state="disabled")

    def _poll(self):
        try:
            while True:
                src, data = self.q.get_nowait()
                for ln in str(data).splitlines():
                    if not ln:
                        continue
                    ts = time.strftime("[%H:%M:%S]")
                    if self.mode_var.get() == "errors":
                        if src == "log":
                            if "WARNING" in ln or "ERROR" in ln or "CRITICAL" in ln:
                                pass
                            else:
                                continue
                        elif src == "stderr":
                            pass
                        else:
                            continue
                    out = f"{ts} [{src}] {ln}"
                    self.buffer.write(out + "\n")
                    self._append(out)
        except queue.Empty:
            pass
        self.win.after(120, self._poll)

    def start(self):
        if self.active:
            self._append("[DEBUG] already started")
            return
        sys.stdout = _StreamProxy(self.q, "stdout")
        sys.stderr = _StreamProxy(self.q, "stderr")
        root_logger = logging.getLogger()
        root_logger.handlers = [self._log_handler]
        root_logger.setLevel(logging.DEBUG)
        self.active = True
        self._append("[DEBUG] started")

    def stop(self):
        if not self.active:
            self._append("[DEBUG] not active")
            return
        sys.stdout = self._orig_stdout
        sys.stderr = self._orig_stderr
        logging.getLogger().handlers = self._orig_handlers
        self.active = False
        self._append("[DEBUG] stopped")

    def save(self, path: str = None):
        if path is None:
            ts = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            path = os.path.join(os.path.dirname(os.path.dirname(__file__)), f"debug_log_{ts}.txt")
        try:
            with open(path, "w", encoding="utf-8") as f:
                f.write(self.buffer.getvalue())
            self._append(f"[DEBUG] saved to {path}")
        except Exception as e:
            self._append(f"[DEBUG] save error: {e}")

    # —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å write/flush
    def write(self, data):
        if data:
            self.q.put(("custom", str(data)))
    def flush(self):
        pass


--- FILE: ui\dev_cli.py ---
# ui/dev_cli.py
"""
DevCLI - –Ω–µ–±–æ–ª—å—à–∞—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.

–ö–æ–º–∞–Ω–¥—ã:
  help                       - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
  tables                     - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ sqlite
  notes                      - –≤—ã–≤–µ—Å—Ç–∏ –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏
  sql <–∑–∞–ø—Ä–æ—Å>               - –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  dump                       - –≤—ã–≤–µ—Å—Ç–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .py —Ñ–∞–π–ª–æ–≤ –≤ –æ–∫–Ω–æ
  dump save                  - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∂–¥—ã–π .py –≤ dcli_dumps/<name>.txt
  dump all [–∏–º—è_—Ñ–∞–π–ª–∞]       - —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ .py –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª dcli_dumps/all_code_<ts>.txt
  debug                      - –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ Debugger (–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π)
  clear                      - –æ—á–∏—Å—Ç–∏—Ç—å –æ–∫–Ω–æ –≤—ã–≤–æ–¥–∞
"""
import os
import sys
import sqlite3
import datetime
import tkinter as tk
from tkinter import ttk

# –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π helper –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (–æ–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –æ–±—ä–µ–∫—Ç —Å –º–µ—Ç–æ–¥–æ–º fetchall)
class _SafeDB:
    def __init__(self, db_obj):
        self._db = db_obj

    def fetchall(self, query: str):
        # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: –æ–±—ä–µ–∫—Ç Database —Å –º–µ—Ç–æ–¥–æ–º fetchall –∏–ª–∏ sqlite3.Connection
        if self._db is None:
            raise RuntimeError("DB not provided")
        if hasattr(self._db, "fetchall"):
            return self._db.fetchall(query)
        # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω sqlite3.Connection
        cur = self._db.cursor()
        cur.execute(query)
        return cur.fetchall()


class DevCLI:
    def __init__(self, master, db=None, notes_service=None):
        """
        master      - parent TK widget (–æ–±—ã—á–Ω–æ root –∏–ª–∏ frame)
        db          - –æ–±—ä–µ–∫—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ª–∏–±–æ sqlite3.Connection; –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å fetchall(query)
        notes_service - —Å–µ—Ä–≤–∏—Å –∑–∞–º–µ—Ç–æ–∫ —Å –º–µ—Ç–æ–¥–æ–º get_all_notes()
        """
        self.master = master
        self.db = _SafeDB(db) if db is not None else None
        self.notes_service = notes_service

        self.win = tk.Toplevel(master)
        self.win.title("DCLI")
        self.win.geometry("900x520")

        # –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥ (–∫–æ–Ω—Å–æ–ª—å)
        self.output = tk.Text(self.win, wrap="word", state="disabled",
                              bg="black", fg="lime", insertbackground="lime", padx=6, pady=6)
        self.output.pack(fill="both", expand=True, padx=6, pady=(6, 0))

        # –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞
        entry_frame = ttk.Frame(self.win)
        entry_frame.pack(fill="x", padx=6, pady=6)

        self.cmd_entry = ttk.Entry(entry_frame)
        self.cmd_entry.pack(side="left", fill="x", expand=True)
        self.cmd_entry.bind("<Return>", self._on_enter)

        ttk.Button(entry_frame, text="–í—ã–ø–æ–ª–Ω–∏—Ç—å", command=self._run_cmd).pack(side="left", padx=6)
        ttk.Button(entry_frame, text="–û—á–∏—Å—Ç–∏—Ç—å", command=self._clear).pack(side="left")

        # –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        self._print("–ì–û–¢–û–í. –í–≤–µ–¥–∏—Ç–µ 'help' –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.")

    # ----------------- –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã -----------------
    def _print(self, text: str):
        self.output.configure(state="normal")
        self.output.insert("end", text + "\n")
        self.output.see("end")
        self.output.configure(state="disabled")

    def _clear(self):
        self.output.configure(state="normal")
        self.output.delete("1.0", "end")
        self.output.configure(state="disabled")

    def _on_enter(self, _event=None):
        self._run_cmd()

    def _run_cmd(self):
        cmd = self.cmd_entry.get().strip()
        self.cmd_entry.delete(0, "end")
        self.execute(cmd)

    # ----------------- –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä –∫–æ–º–∞–Ω–¥ -----------------
    def execute(self, cmd: str):
        if not cmd:
            return
        self._print(f"> {cmd}")

        parts = cmd.split()
        head = parts[0].lower()

        try:
            if head == "help":
                self._cmd_help()
            elif head == "tables":
                self._cmd_tables()
            elif head == "notes":
                self._cmd_notes()
            elif head == "sql":
                self._cmd_sql(" ".join(parts[1:]))
            elif head == "dump":
                # –ü–æ–¥–∫–æ–º–∞–Ω–¥—ã: dump, dump save, dump all
                if len(parts) == 1:
                    self._dump_code(print_only=True)
                elif parts[1] == "save":
                    self._dump_code(print_only=False)
                elif parts[1] == "all":
                    name = parts[2] if len(parts) > 2 else None
                    path = self._dump_code_all(out_filename=name)
                    self._print(f"[dump all] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: {path}")
                else:
                    self._print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dump | dump save | dump all [–∏–º—è_—Ñ–∞–π–ª–∞]")
            elif head == "debug":
                self._cmd_debug()
            elif head == "clear":
                self._clear()
            else:
                self._print("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. help ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.")
        except Exception as e:
            self._print(f"[ERROR] {e}")

    # ----------------- —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥ -----------------
    def _cmd_help(self):
        lines = [
            "–ö–æ–º–∞–Ω–¥—ã:",
            "  help                       - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫",
            "  tables                     - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã sqlite",
            "  notes                      - –≤—ã–≤–µ—Å—Ç–∏ –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏",
            "  sql <–∑–∞–ø—Ä–æ—Å>               - –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å",
            "  dump                       - –≤—ã–≤–µ—Å—Ç–∏ .py –≤ –æ–∫–Ω–æ",
            "  dump save                  - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∂–¥—ã–π .py –≤ dcli_dumps/",
            "  dump all [–∏–º—è_—Ñ–∞–π–ª–∞]       - —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ .py –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª",
            "  debug                      - –æ—Ç–∫—Ä—ã—Ç—å Debugger –æ–∫–Ω–æ",
            "  clear                      - –æ—á–∏—Å—Ç–∏—Ç—å –æ–∫–Ω–æ –≤—ã–≤–æ–¥–∞"
        ]
        for l in lines:
            self._print(l)

    def _cmd_tables(self):
        if self.db is None:
            self._print("[tables] DB –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞")
            return
        try:
            rows = self.db.fetchall("SELECT name FROM sqlite_master WHERE type='table'")
            names = ", ".join(r[0] for r in rows) if rows else "(–Ω–µ—Ç —Ç–∞–±–ª–∏—Ü)"
            self._print("–¢–∞–±–ª–∏—Ü—ã: " + names)
        except Exception as e:
            self._print(f"[tables] –û—à–∏–±–∫–∞: {e}")

    def _cmd_notes(self):
        if self.notes_service is None:
            self._print("[notes] notes_service –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω")
            return
        try:
            notes = self.notes_service.get_all_notes()
            if not notes:
                self._print("(–Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫)")
                return
            for n in notes:
                self._print(str(n))
        except Exception as e:
            self._print(f"[notes] –û—à–∏–±–∫–∞: {e}")

    def _cmd_sql(self, query: str):
        if not query:
            self._print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sql <–∑–∞–ø—Ä–æ—Å>")
            return
        if self.db is None:
            self._print("[sql] DB –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞")
            return
        try:
            rows = self.db.fetchall(query)
            if not rows:
                self._print("(–ø—É—Å—Ç–æ)")
                return
            for r in rows:
                self._print(str(tuple(r)))
        except sqlite3.Error as e:
            self._print(f"[SQL Error] {e}")
        except Exception as e:
            self._print(f"[sql] –û—à–∏–±–∫–∞: {e}")

    def _cmd_debug(self):
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ DebugUI; –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ –ø–∞–∫–µ—Ç–∞ ui
        try:
            from .debug_ui import DebugUI
        except Exception:
            # fallback: –ø–æ–ø—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç –∫–∞–∫ –∫–æ—Ä–Ω–µ–≤–æ–π –º–æ–¥—É–ª—å (–µ—Å–ª–∏ dev_cli.py –Ω–µ –≤ ui/)
            try:
                import importlib, os
                sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
                DebugUI = importlib.import_module("ui.debug_ui").DebugUI
            except Exception as e:
                self._print(f"[debug] –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å DebugUI: {e}")
                return

        # –£–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–∫–Ω–æ, —á—Ç–æ–±—ã –æ–Ω–æ –Ω–µ –±—ã–ª–æ —Å–æ–±—Ä–∞–Ω–Ω—ã–º GC
        if not hasattr(self, "_debug_window") or self._debug_window is None or not self._debug_window.win.winfo_exists():
            try:
                self._debug_window = DebugUI(self.win if hasattr(self, "win") else self.master)
                self._print("[debug] –û–∫–Ω–æ Debugger –æ—Ç–∫—Ä—ã—Ç–æ")
            except Exception as e:
                self._print(f"[debug] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–∫–Ω–∞: {e}")
        else:
            try:
                self._debug_window.win.lift()
                self._print("[debug] –û–∫–Ω–æ Debugger –ø–æ–¥–Ω—è—Ç–æ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω")
            except Exception:
                pass

    # ----------------- –¥–∞–º–ø –∫–æ–¥–∞ –ø–æ —Ñ–∞–π–ª–∞–º -----------------
    def _dump_code(self, print_only: bool = True):
        """
        –û–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç –æ—Ç –∫–æ—Ä–Ω—è (—Ä–æ–¥–∏—Ç–µ–ª—å –ø–∞–ø–∫–∏ ui/) –∏:
          - print_only=True: –ø–µ—á–∞—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .py —Ñ–∞–π–ª–æ–≤ –≤ –æ–∫–Ω–æ.
          - print_only=False: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–∂–¥—ã–π .py –≤ dcli_dumps/<–∏–º—è>.txt
        """
        try:
            root_dir = os.path.dirname(os.path.dirname(__file__))
            dump_dir = os.path.join(root_dir, "dcli_dumps")
            if not print_only:
                os.makedirs(dump_dir, exist_ok=True)

            for dirpath, _, files in os.walk(root_dir):
                # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º __pycache__ –∏ —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏
                if os.path.basename(dirpath).startswith("__pycache__"):
                    continue
                for fname in sorted(files):
                    if not fname.endswith(".py"):
                        continue
                    path = os.path.join(dirpath, fname)
                    rel = os.path.relpath(path, root_dir)
                    try:
                        with open(path, "r", encoding="utf-8") as fh:
                            content = fh.read()
                    except Exception as e:
                        self._print(f"[dump] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {rel}: {e}")
                        continue

                    if print_only:
                        self._print(f"\n--- {rel} ---")
                        # –ø–µ—á–∞—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –ø–∞–º—è—Ç—å
                        for line in content.splitlines():
                            self._print(line)
                    else:
                        out_path = os.path.join(dump_dir, fname.replace(".py", ".txt"))
                        try:
                            with open(out_path, "w", encoding="utf-8") as out:
                                out.write(content)
                            self._print(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {out_path}")
                        except Exception as e:
                            self._print(f"[dump save] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ {out_path}: {e}")

            self._print("[dump] –ì–æ—Ç–æ–≤–æ.")
        except Exception as e:
            self._print(f"[dump] –û—à–∏–±–∫–∞: {e}")

    # ----------------- –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –¥–∞–º–ø –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ –æ–¥–∏–Ω -----------------
    def _dump_code_all(self, out_filename: str = None) -> str:
        """
        –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ .py —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É.
        """
        root_dir = os.path.dirname(os.path.dirname(__file__))
        dumps_dir = os.path.join(root_dir, "dcli_dumps")
        os.makedirs(dumps_dir, exist_ok=True)

        if out_filename:
            safe_name = out_filename
        else:
            ts = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            safe_name = f"all_code_{ts}.txt"

        out_path = os.path.join(dumps_dir, safe_name)

        with open(out_path, "w", encoding="utf-8") as out_f:
            header = (
                f"All project .py files dump\nGenerated: {datetime.datetime.now().isoformat()}\n"
                f"Project root: {root_dir}\n\n"
            )
            out_f.write(header)
            for dirpath, _, files in os.walk(root_dir):
                # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏
                base = os.path.basename(dirpath)
                if base.startswith("__pycache__") or base.startswith("."):
                    continue
                rel_dir = os.path.relpath(dirpath, root_dir)
                for fname in sorted(files):
                    if not fname.endswith(".py"):
                        continue
                    file_path = os.path.join(dirpath, fname)
                    rel_path = os.path.join(rel_dir, fname) if rel_dir != "." else fname
                    out_f.write(f"\n--- FILE: {rel_path} ---\n")
                    try:
                        with open(file_path, "r", encoding="utf-8") as fh:
                            out_f.write(fh.read() + "\n")
                    except Exception as e:
                        out_f.write(f"[ERROR reading file: {e}]\n")

        return out_path


--- FILE: ui\main_ui.py ---
# ui/main_ui.py
import tkinter as tk
from tkinter import ttk

from services.db import Database
from services.notes_service import NotesService
from .notes_ui import NotesUI
from .dev_cli import DevCLI


class RacconApp:
    """
    –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –ë–∞–∑–æ–≤—ã–π –º–∏–Ω–∏–º—É–º: –≤–∫–ª–∞–¥–∫–∞ '–ó–∞–º–µ—Ç–∫–∏' + –∫–Ω–æ–ø–∫–∞ DCLI –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
    """

    def __init__(self, db_path: str = "raccon.db"):
        # –ö–æ—Ä–Ω–µ–≤–æ–µ –æ–∫–Ω–æ
        self.root = tk.Tk()
        self.root.title("Raccon Pro")
        self.root.geometry("900x600")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
        self.db = Database(db_path)
        self.notes_service = NotesService(self.db)

        # –û—Å–Ω–æ–≤–Ω–æ–π Notebook
        self.notebook = ttk.Notebook(self.root)
        self.notebook.pack(fill="both", expand=True)

        # –í–∫–ª–∞–¥–∫–∞: –ó–∞–º–µ—Ç–∫–∏
        self.notes_tab = NotesUI(self.notebook, self.notes_service)
        self.notebook.add(self.notes_tab.frame, text="–ó–∞–º–µ—Ç–∫–∏")

        # –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ –±—É–¥—É—â–∏–µ –º–æ–¥—É–ª–∏
        self.tasks_tab = ttk.Frame(self.notebook)
        self.passwords_tab = ttk.Frame(self.notebook)
        self.notebook.add(self.tasks_tab, text="–ó–∞–¥–∞—á–∏")
        self.notebook.add(self.passwords_tab, text="–ü–∞—Ä–æ–ª–∏")

        # –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–æ–π DCLI
        bottom_frame = ttk.Frame(self.root)
        bottom_frame.pack(fill="x", side="bottom", pady=4)

        dcli_btn = ttk.Button(bottom_frame, text="DCLI", command=self.open_cli)
        dcli_btn.pack(side="left", padx=6)

    def open_cli(self):
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º DevCLI –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ
        DevCLI(self.root, db=self.db, notes_service=self.notes_service)

    def run(self):
        self.root.mainloop()


--- FILE: ui\notes_ui.py ---
# ui/notes_ui.py
import json
import tkinter as tk
from tkinter import ttk, messagebox, filedialog


class FormattingPanel(tk.Toplevel):
    """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: —Ä–∞–º–∫–∞, –∑–∞–≥–æ–ª–æ–≤–æ–∫, Pin/Unpin.
    –ü—Ä–∏ Pin –ø–∞–Ω–µ–ª—å —Å–ª–µ–¥—É–µ—Ç –∑–∞ –æ–∫–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ –±—ã—Å—Ç—Ä—ã–π Configure-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫.
    """
    WIDTH = 300

    def __init__(self, editor_win: tk.Toplevel, text_widget: tk.Text, format_meta: dict | None):
        super().__init__(editor_win)
        self.editor_win = editor_win
        self.text = text_widget
        self.format_meta = format_meta or {}
        self.pinned = False
        self._following = False

        self.title("–ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        self.geometry(f"{self.WIDTH}x420")
        self.protocol("WM_DELETE_WINDOW", self.hide)
        self.withdraw()  # —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        # –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–∫—Ä–æ–µ—Ç—Å—è ‚Äî –∑–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
        try:
            self.editor_win.bind("<Destroy>", lambda e: self.destroy(), add="+")
        except Exception:
            pass

        self._build_ui()
        self._ensure_tags()

    def _build_ui(self):
        frm = ttk.Frame(self, padding=8)
        frm.pack(fill="both", expand=True)

        header = ttk.Frame(frm)
        header.pack(fill="x", pady=(0, 8))
        ttk.Label(header, text="–ü–∞–Ω–µ–ª—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", font=("", 10, "bold")).pack(side="left")
        self.pin_btn = ttk.Button(header, text="Pin", width=8, command=self._toggle_pin)
        self.pin_btn.pack(side="right")

        ttk.Separator(frm, orient="horizontal").pack(fill="x", pady=(6, 8))

        ttk.Button(frm, text="–ñ–∏—Ä–Ω—ã–π", command=lambda: self.apply_style("bold")).pack(fill="x", pady=4)
        ttk.Button(frm, text="–ö—É—Ä—Å–∏–≤", command=lambda: self.apply_style("italic")).pack(fill="x", pady=4)
        ttk.Button(frm, text="–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π", command=lambda: self.apply_style("underline")).pack(fill="x", pady=4)
        ttk.Button(frm, text="–ó–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π", command=lambda: self.apply_style("strike")).pack(fill="x", pady=4)

        ttk.Separator(frm, orient="horizontal").pack(fill="x", pady=(8, 8))
        ttk.Button(frm, text="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç", command=self.clear_meta).pack(fill="x", pady=4)
        ttk.Button(frm, text="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å", command=self.hide).pack(fill="x", pady=(8, 0))

    def _ensure_tags(self):
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–≥–æ–≤ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        try:
            self.text.tag_configure("fmt_bold", font=("Segoe UI", 10, "bold"))
            self.text.tag_configure("fmt_italic", font=("Segoe UI", 10, "italic"))
            self.text.tag_configure("fmt_underline", underline=1)
            self.text.tag_configure("fmt_strike", overstrike=1)
        except Exception:
            pass

    # ------------- Pin / follow logic -------------
    def _toggle_pin(self):
        self.pinned = not self.pinned
        self.pin_btn.config(text="Unpin" if self.pinned else "Pin")
        if self.pinned:
            try:
                self.transient(self.editor_win)
            except Exception:
                pass
            self._start_following_editor()
        else:
            try:
                self.transient(None)
            except Exception:
                pass
            self._stop_following_editor()

    def _start_following_editor(self):
        if self._following:
            return
        self._following = True

        def _on_editor_configure(event=None):
            try:
                # –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–≤–µ–∂–∏–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –ø–æ–∑–∏—Ü–∏–∏
                self.editor_win.update_idletasks()
                ex = self.editor_win.winfo_rootx()
                ey = self.editor_win.winfo_rooty()
                ew = self.editor_win.winfo_width()
                eh = self.editor_win.winfo_height()
                if ew <= 1 or eh <= 1:
                    return
                px = ex + ew + 10
                py = ey
                # –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞: —Ç–æ–ª—å–∫–æ geometry, –±–µ–∑ –ª–∏—à–Ω–µ–π –ª–æ–≥–∏–∫–∏
                self.geometry(f"{self.WIDTH}x{eh}+{px}+{py}")
            except Exception:
                pass

        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è (best-effort)
        self._editor_configure_handler = _on_editor_configure
        try:
            # bind —Å add="+" ‚Äî –Ω–µ —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            self.editor_win.bind("<Configure>", self._editor_configure_handler, add="+")
            # –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Å—Ä–∞–∑—É
            self._editor_configure_handler()
        except Exception:
            # fallback: –≤—Å—ë –µ—â—ë –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å, –Ω–æ –±–µ–∑ –±–∏–Ω–¥–∞
            try:
                self._position_right_of_editor()
            except Exception:
                pass

    def _stop_following_editor(self):
        if not self._following:
            return
        self._following = False
        # –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫; tkinter –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é,
        # –ø–æ—ç—Ç–æ–º—É –≤—ã–ø–æ–ª–Ω—è–µ–º best-effort: unbind –≤—Å–µ—Ö Configure (—Ä–µ–¥–∫–æ –∫—Ä–∏—Ç–∏—á–Ω–æ) –∏ –∑–∞—Ç–µ–º –º–æ–∂–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        try:
            # –µ—Å–ª–∏ –º—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ç–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞—à –±–∏–Ω–¥–∏–Ω–≥, –ø–æ–ø—ã—Ç–∞–µ–º—Å—è (–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è)
            self.editor_win.unbind("<Configure>", self._editor_configure_handler)
        except Exception:
            try:
                # –±–µ–∑–æ–ø–∞—Å–Ω—ã–π, –Ω–æ –≥—Ä—É–±—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: —É–±–∏—Ä–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Configure
                self.editor_win.unbind("<Configure>")
            except Exception:
                pass
        finally:
            if hasattr(self, "_editor_configure_handler"):
                try:
                    del self._editor_configure_handler
                except Exception:
                    pass

    def _position_right_of_editor(self):
        try:
            ex = self.editor_win.winfo_rootx()
            ey = self.editor_win.winfo_rooty()
            ew = self.editor_win.winfo_width()
            eh = self.editor_win.winfo_height()
            if ew <= 1 or eh <= 1:
                self.after(30, self._position_right_of_editor)
                return
            px = ex + ew + 10
            py = ey
            self.geometry(f"{self.WIDTH}x{eh}+{px}+{py}")
        except Exception:
            pass

    def show(self):
        if self.pinned:
            self._position_right_of_editor()
        self.deiconify()
        self.lift()
        self._apply_all_meta_tags()

    def hide(self):
        self.withdraw()

    # ------------- —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö -------------
    def _index_to_offset(self, idx: str) -> int:
        line, col = map(int, str(idx).split("."))
        offset = 0
        for l in range(1, line):
            line_text = self.text.get(f"{l}.0", f"{l}.end")
            offset += len(line_text) + 1
        offset += col
        return offset

    def _offset_to_index(self, offset: int) -> str:
        line = 1
        while True:
            line_text = self.text.get(f"{line}.0", f"{line}.end")
            line_len = len(line_text) + 1
            if offset < line_len:
                col = offset
                return f"{line}.{col}"
            offset -= line_len
            line += 1

    def _get_selection_bounds_offsets(self):
        try:
            s = self.text.index("sel.first")
            e = self.text.index("sel.last")
        except tk.TclError:
            return None
        return self._index_to_offset(s), self._index_to_offset(e)

    def _record_range(self, style: str, start_off: int, end_off: int):
        if start_off >= end_off:
            return
        lst = self.format_meta.get(style, [])
        lst.append([start_off, end_off])
        self.format_meta[style] = lst
        self._apply_meta_tag(style, start_off, end_off)

    def apply_style(self, style_key: str):
        bounds = self._get_selection_bounds_offsets()
        if not bounds:
            messagebox.showinfo("–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", "–í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å")
            return
        start_off, end_off = bounds
        self._record_range(style_key, start_off, end_off)

    def clear_meta(self):
        if not messagebox.askyesno("–û—á–∏—Å—Ç–∫–∞", "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?"):
            return
        self.format_meta.clear()
        self._remove_all_meta_tags()
        messagebox.showinfo("–û—á–∏—Å—Ç–∫–∞", "–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã")

    def _apply_meta_tag(self, style: str, start_off: int, end_off: int):
        tag = self._style_to_tag(style)
        try:
            start_idx = self._offset_to_index(start_off)
            end_idx = self._offset_to_index(end_off)
            self.text.tag_add(tag, start_idx, end_idx)
        except Exception:
            pass

    def _apply_all_meta_tags(self):
        self._remove_all_meta_tags()
        for style, ranges in self.format_meta.items():
            for r in ranges:
                try:
                    self._apply_meta_tag(style, int(r[0]), int(r[1]))
                except Exception:
                    pass

    def _remove_all_meta_tags(self):
        for tag in ("fmt_bold", "fmt_italic", "fmt_underline", "fmt_strike"):
            try:
                self.text.tag_remove(tag, "1.0", "end")
            except Exception:
                pass

    def _style_to_tag(self, style: str) -> str:
        return {
            "bold": "fmt_bold",
            "italic": "fmt_italic",
            "underline": "fmt_underline",
            "strike": "fmt_strike"
        }.get(style, "fmt_bold")

    def get_format_meta_json(self) -> str:
        return json.dumps(self.format_meta, ensure_ascii=False)


# ---------------- NotesUI ----------------
class NotesUI:
    def __init__(self, master, notes_service):
        self.master = master
        self.notes_service = notes_service
        self.frame = ttk.Frame(master)

        control = ttk.Frame(self.frame)
        control.pack(fill="x", padx=8, pady=8)

        ttk.Label(control, text="–ó–∞–≥–æ–ª–æ–≤–æ–∫:").pack(side="left")
        self.title_entry = ttk.Entry(control, width=30)
        self.title_entry.pack(side="left", padx=6)

        ttk.Label(control, text="–¢–µ–≥–∏:").pack(side="left")
        self.tags_entry = ttk.Entry(control, width=20)
        self.tags_entry.pack(side="left", padx=6)

        ttk.Button(control, text="–î–æ–±–∞–≤–∏—Ç—å", command=self.add_note).pack(side="left", padx=6)

        ttk.Label(control, text="–ü–æ–∏—Å–∫:").pack(side="left", padx=(20, 0))
        self.search_entry = ttk.Entry(control, width=25)
        self.search_entry.pack(side="left", padx=6)

        ttk.Button(control, text="–ò—Å–∫–∞—Ç—å", command=self.search_notes).pack(side="left", padx=6)
        ttk.Button(control, text="–°–±—Ä–æ—Å", command=self.load_notes).pack(side="left", padx=6)

        table_frame = ttk.Frame(self.frame)
        table_frame.pack(fill="both", expand=True, padx=8, pady=6)

        self.tree = ttk.Treeview(
            table_frame,
            columns=("id", "title", "tags", "created_at"),
            show="headings",
            height=16
        )
        vsb = ttk.Scrollbar(table_frame, orient="vertical", command=self.tree.yview)
        self.tree.configure(yscrollcommand=vsb.set)
        self.tree.grid(row=0, column=0, sticky="nsew")
        vsb.grid(row=0, column=1, sticky="ns")
        table_frame.rowconfigure(0, weight=1)
        table_frame.columnconfigure(0, weight=1)

        self.tree.heading("id", text="ID")
        self.tree.heading("title", text="–ó–∞–≥–æ–ª–æ–≤–æ–∫")
        self.tree.heading("tags", text="–¢–µ–≥–∏")
        self.tree.heading("created_at", text="–°–æ–∑–¥–∞–Ω–æ")

        self.tree.column("id", width=60, anchor="center")
        self.tree.column("title", width=360, anchor="w")
        self.tree.column("tags", width=180, anchor="w")
        self.tree.column("created_at", width=160, anchor="center")

        self.tree.bind("<Double-1>", self._on_double_click)

        bottom = ttk.Frame(self.frame)
        bottom.pack(fill="x", padx=8, pady=8)

        ttk.Button(bottom, text="–£–¥–∞–ª–∏—Ç—å", command=self.delete_note).pack(side="left")
        ttk.Button(bottom, text="–ü—Ä–æ—Å–º–æ—Ç—Ä", command=self.view_note).pack(side="left", padx=6)
        ttk.Button(bottom, text="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", command=self.edit_note).pack(side="left", padx=6)

        self.load_notes()

    def get_frame(self):
        return self.frame

    # ---------------- CRUD –∏ –ø–æ–∏—Å–∫ ----------------
    def load_notes(self):
        for row in self.tree.get_children():
            self.tree.delete(row)
        try:
            rows = self.notes_service.get_all_notes()
            if rows:
                for note in rows:
                    self.tree.insert("", "end", values=note)
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏: {e}")

    def add_note(self):
        title = self.title_entry.get().strip()
        tags = self.tags_entry.get().strip()
        if not title:
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
            return
        try:
            self.notes_service.create_note(title, "", tags)
            self.title_entry.delete(0, "end")
            self.tags_entry.delete(0, "end")
            self.title_entry.focus_set()
            self.load_notes()
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", str(e))

    def search_notes(self):
        q = self.search_entry.get().strip()
        if not q:
            self.load_notes()
            return
        try:
            results = self.notes_service.search_notes(q)
            for row in self.tree.get_children():
                self.tree.delete(row)
            if not results:
                messagebox.showinfo("–ü–æ–∏—Å–∫", "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
                return
            for note in results:
                self.tree.insert("", "end", values=note)
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", str(e))

    def delete_note(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            return
        note_id = self.tree.item(sel[0])["values"][0]
        if messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ", "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–º–µ—Ç–∫—É?"):
            try:
                self.notes_service.delete_note(note_id)
                self.load_notes()
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", str(e))

    def view_note(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞")
            return
        note_id = self.tree.item(sel[0])["values"][0]
        try:
            note = self.notes_service.get_note_by_id(note_id)
            if not note:
                messagebox.showerror("–û—à–∏–±–∫–∞", "–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                return
            if len(note) == 6:
                _, title, content, tags, created_at, _ = note
            else:
                _, title, content, tags, created_at = note
            messagebox.showinfo(
                "–ó–∞–º–µ—Ç–∫–∞",
                f"–ó–∞–≥–æ–ª–æ–≤–æ–∫: {title}\n–¢–µ–≥–∏: {tags}\n–°–æ–∑–¥–∞–Ω–æ: {created_at}\n\n{content}"
            )
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", str(e))

    def edit_note(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
        note_id = self.tree.item(sel[0])["values"][0]
        note = self.notes_service.get_note_by_id(note_id)
        if not note:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        if len(note) == 6:
            _, title, content, tags, created_at, format_meta = note
        else:
            _, title, content, tags, created_at = note
            format_meta = "{}"

        try:
            original_meta = json.loads(format_meta or "{}")
        except Exception:
            original_meta = {}
        working_meta = json.loads(json.dumps(original_meta))

        win = tk.Toplevel(self.master)
        win.title("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É")
        win.geometry("920x560")
        win.transient(self.master)

        container = ttk.Frame(win)
        container.pack(fill="both", expand=True, padx=8, pady=8)

        editor_frame = ttk.Frame(container)
        editor_frame.pack(side="left", fill="both", expand=True)

        top_fields = ttk.Frame(editor_frame)
        top_fields.pack(fill="x", padx=4, pady=(0, 6))

        ttk.Label(top_fields, text="–ó–∞–≥–æ–ª–æ–≤–æ–∫:").grid(row=0, column=0, sticky="w")
        title_entry = ttk.Entry(top_fields)
        title_entry.grid(row=0, column=1, sticky="ew", padx=8)
        title_entry.insert(0, title or "")
        top_fields.columnconfigure(1, weight=1)

        ttk.Label(top_fields, text="–¢–µ–≥–∏:").grid(row=1, column=0, sticky="w", pady=(6, 0))
        tags_entry = ttk.Entry(top_fields)
        tags_entry.grid(row=1, column=1, sticky="ew", padx=8, pady=(6, 0))
        tags_entry.insert(0, tags or "")

        content_frame = ttk.Frame(editor_frame)
        content_frame.pack(fill="both", expand=True, padx=4, pady=4)

        text_area = tk.Text(content_frame, wrap="word")
        text_area.pack(side="left", fill="both", expand=True)
        text_area.insert("1.0", content or "")

        text_vsb = ttk.Scrollbar(content_frame, orient="vertical", command=text_area.yview)
        text_vsb.pack(side="right", fill="y")
        text_area.configure(yscrollcommand=text_vsb.set)

        # –ø–∞–Ω–µ–ª—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ, —Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        panel = FormattingPanel(win, text_area, working_meta)

        footer = ttk.Frame(win)
        footer.pack(fill="x", padx=12, pady=(6, 10))

        left_box = ttk.Frame(footer)
        left_box.pack(side="left")

        def toggle_panel():
            try:
                if panel.state() == "normal":
                    panel.hide()
                else:
                    panel.show()
            except Exception:
                panel.show()

        ttk.Button(left_box, text="–†–µ–¥–∞–∫—Ç.", command=toggle_panel).pack(side="left")

        def export_md():
            path = filedialog.asksaveasfilename(title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ Markdown", defaultextension=".md",
                                                filetypes=[("Markdown", "*.md"), ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")])
            if not path:
                return
            try:
                cur_title = title_entry.get().strip()
                cur_tags = tags_entry.get().strip()
                cur_content = text_area.get("1.0", "end-1c")
                self.notes_service.update_note(
                    note_id, cur_title, cur_content, cur_tags, panel.get_format_meta_json()
                )
                self.notes_service.export_note_md(note_id, path)
                messagebox.showinfo("–≠–∫—Å–ø–æ—Ä—Ç", f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {path}")
            except Exception as e:
                messagebox.showerror("–≠–∫—Å–ø–æ—Ä—Ç", f"–û—à–∏–±–∫–∞: {e}")

        def export_html():
            path = filedialog.asksaveasfilename(title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ HTML", defaultextension=".html",
                                                filetypes=[("HTML", "*.html"), ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")])
            if not path:
                return
            try:
                cur_title = title_entry.get().strip()
                cur_tags = tags_entry.get().strip()
                cur_content = text_area.get("1.0", "end-1c")
                self.notes_service.update_note(
                    note_id, cur_title, cur_content, cur_tags, panel.get_format_meta_json()
                )
                self.notes_service.export_note_html(note_id, path)
                messagebox.showinfo("–≠–∫—Å–ø–æ—Ä—Ç", f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {path}")
            except Exception as e:
                messagebox.showerror("–≠–∫—Å–ø–æ—Ä—Ç", f"–û—à–∏–±–∫–∞: {e}")

        ttk.Button(left_box, text="–≠–∫—Å–ø–æ—Ä—Ç MD", command=export_md).pack(side="left", padx=(8, 8))
        ttk.Button(left_box, text="–≠–∫—Å–ø–æ—Ä—Ç HTML", command=export_html).pack(side="left")

        right_box = ttk.Frame(footer)
        right_box.pack(side="right")

        def save_and_close():
            new_title = title_entry.get().strip()
            new_tags = tags_entry.get().strip()
            new_content = text_area.get("1.0", "end-1c")
            if not new_title:
                messagebox.showwarning("–û—à–∏–±–∫–∞", "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
                return
            try:
                self.notes_service.update_note(
                    note_id, new_title, new_content, new_tags, panel.get_format_meta_json()
                )
                try:
                    panel.destroy()
                except Exception:
                    pass
                self.load_notes()
                win.destroy()
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", str(e))

        def cancel_and_close():
            try:
                panel.destroy()
            except Exception:
                pass
            win.destroy()

        ttk.Button(right_box, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", command=save_and_close).pack(side="right", padx=6)
        ttk.Button(right_box, text="–û—Ç–º–µ–Ω–∞", command=cancel_and_close).pack(side="right")

        panel._apply_all_meta_tags()
        title_entry.focus_set()

    def _on_double_click(self, event):
        sel = self.tree.identify_row(event.y)
        if sel:
            self.tree.selection_set(sel)
            self.edit_note()

